<!DOCTYPE html>
<html>
<head>
  <script src='/socket.io/socket.io.js'></script>
  <script>
    var socket = io();

    socket.on("connectedChange", function(){
      fetch("/chatroom", {
        headers: {
          accept: "application/json"
        },
        credentials: 'include'
      }).then(function(response){
        if(!response.ok){
          console.log("Whoops! something broke: " + response.statusText);
        }
        else{
          return Promise.resolve(response);
        }
      }).then(function(response){
        return response.json();
      }).then(function(data){
        var users = data.users;
        var textarea = document.getElementById("connected_users");
        textarea.innerHTML = "Users:\n";
        for(var i=0;i<users.length;i++){
          if(i < (users.length -1)){
            textarea.innerHTML += users[i].nickname + "\n";
          }
          else{
            textarea.innerHTML += users[i].nickname;
          }
        }
      })
    })

    socket.on("newMessage", function(){
      fetch("/chatroom", {
        headers: {
          accept: "application/json"
        },
        credentials: 'include'
      }).then(function(response){
        if(!response.ok){
          console.log("Whoops! something broke: " + response.statusText);
        }
        else{
          return Promise.resolve(response);
        }
      }).then(function(response){
        return response.json();
      }).then(function(data){
        var messages = data.messages;
        var chatarea = document.getElementById("chat");
        chatarea.innerHTML = "";
        for(var i=0;i<messages.length;i++){
          if(messages[i].substr(0, messages[i].indexOf(":")) != "<%=name%>"){
            var bubble_you = document.createElement("div");
            bubble_you.setAttribute("class", "bubble you");
            var your_message = messages[i];
            bubble_you.innerHTML += your_message;
            chatarea.appendChild(bubble_you);
          }
          else{
            var bubble_me = document.createElement("div");
            bubble_me.setAttribute("class", "bubble me");
            var my_message = messages[i];
            bubble_me.innerHTML += my_message;
            chatarea.appendChild(bubble_me);
          }
        }
        setTimeout(function(){
          var textarea = document.getElementById("chat");
          textarea.scrollTop = textarea.scrollHeight;
        }, 10) // Attempt to stick to the most recent message to prevent the user from being thrown back to the top each time a new message is sent
      })
      if (!("Notification" in window)){
        alert("This browser does not support desktop notifications");
      }
      else if (Notification.permission === "granted"){
        var notification = new Notification("New Message!");
      }
      else if (Notification.permission !== "denied"){
        Notification.requestPermission(function(permission){
          if (permission === "granted"){
            var notification = new Notification("New Message!");
          }
        })
      }
    });

    document.addEventListener("DOMContentLoaded", function(event){
      document.getElementById("sign_out").addEventListener("click", function(event){
        window.location = "/logout";
      })
      var textarea = document.getElementById("chat");
      textarea.scrollTop = textarea.scrollHeight;
      var chatform = document.getElementById("chatroom");
      chatform.addEventListener("submit", function(event){
        event.preventDefault();
        fetch("/chatroom", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: 'include',
          body: JSON.stringify({message: chatform["message"].value})
        }).then(function(response){
          chatform["message"].value = "";
        })
      })
    });
  </script>
  <style>
    form{
      margin: 0 auto;
      width: 700px;
      padding: 1em;
      border: 1px solid #CCC;
      border-radius: 1em;
      background-color: #D0DDFF;
    }

    form div + div{
      margin-top: .5em;
    }

    label{
      display: inline-block;
      width: auto;
      text-align: left;
      font: 1em sans-serif;
    }

    input, textarea{
      font: 1em sans-serif;
      width: 700px;
      box-sizing: border-box;
      border: 1px solid #999;
    }

    textarea{
      resize: none;
      color: #000000;
      background-color: #F0FFFF;
    }

    #connected_users{
      height: 5em;
      width: auto;
      margin-left: 14.5em;
    }

    input:focus{
      border-color: #000;
    }

    button{
      margin-left: .1em;
      font: 1em sans-serif;
    }

    .chat {
      width: 700px;
      height: 500px;
      overflow-y: scroll;
      background-color: #F0FFFF;
      padding-bottom: 1em;
    }

    .bubble{
      background-color: #F2F2F2;
      border-radius: 5px;
      box-shadow: 0 0 6px #B2B2B2;
      display: inline-block;
      padding: 10px 18px;
      position: relative;
      vertical-align: top;
      box-shadow: none;
    }

    .bubble::before {
      background-color: #F2F2F2;
      content: "\00a0";
      display: block;
      height: 16px;
      position: absolute;
      top: 11px;
      transform:             rotate( 29deg ) skew( -35deg );
          -moz-transform:    rotate( 29deg ) skew( -35deg );
          -ms-transform:     rotate( 29deg ) skew( -35deg );
          -o-transform:      rotate( 29deg ) skew( -35deg );
          -webkit-transform: rotate( 29deg ) skew( -35deg );
      width:  20px;
      box-shadow: none;
    }

    .me {
      float: right;
      margin: 5px 45px 5px 20px;
      clear: both;
      background-color: #2273e5;
      color: #FFFFFF;
    }

    .me::before {
      right: -9px;
      background-color: #2273e5;
    }

    .me + .me {
      margin-top: 0px;
      margin-bottom: 0px;
      width: 200px;
      border-radius: 0px;
    }

    .me + .me:last-child{
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }

    .you {
      float: left;
      margin: 5px 20px 5px 45px;
      clear: both;
      background-color: #97e522;
    }

    .you::before {
      left: -9px;
      background-color: #97e522;
    }
  </style>
</head>
<form method="post" id="chatroom" autocomplete="off">
  <div class="chat" id="chat"><%
    for(var i=0;i<messages.length;i++) {
      if(messages[i].substr(0, messages[i].indexOf(":")) !== name) {
        %><div class="bubble you"><%=messages[i]%></div><%
      }
      else{
        %><div class="bubble me"><%=messages[i]%></div><%
      }
    }%>
  </div>
  <div>
    <input type="text" id="messsage_box" name="message" autofocus="true"><button type="submit">Send message</button>
  </div>
  <div>
    <div>
      <label>Hello <%=name%>!</label>
    </div>
    <button type="button" id="sign_out">Sign out</button>
  </div>
  <textarea id="connected_users" name="users_display" wrap="soft" disabled="true">Users:<%for(var i=0; i<users.length; i++) {%>
<%=users[i].nickname%><%} %></textarea>
</form>
</html>
